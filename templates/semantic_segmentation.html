{% extends "base.html" %}

{% block title %}Semantic Segmentation - DeepMed{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Semantic Segmentation Training</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <p><strong>DeepLabV3 + ResNet-50</strong> for semantic segmentation lets you train a model to identify and segment different regions in medical images.</p>
                        <p>Upload a ZIP file containing your images and segmentation masks to train a custom model.</p>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Required ZIP Structure:</h5>
                        <pre class="bg-light p-3 rounded">
dataset.zip
│
├── images/
│   ├── image1.jpg
│   ├── image2.jpg
│   └── ...
│
├── masks/
│   ├── image1.jpg
│   ├── image2.jpg
│   └── ...
│
└── labels.txt (optional)
                        </pre>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Instructions:</h5>
                        <ol>
                            <li>Prepare your images and segmentation masks with matching filenames</li>
                            <li>Masks should be grayscale images with pixel values as class indices (0=background, 1=first class, etc.)</li>
                            <li>Optionally include a labels.txt file with one class name per line (excluding background)</li>
                            <li>Compress these into a ZIP file</li>
                            <li>Select training level (higher levels = more epochs, better quality)</li>
                            <li>Click "Train Model" and wait for training to complete</li>
                        </ol>
                    </div>

                    <form id="uploadForm" class="mt-4">
                        <div class="mb-3">
                            <label for="zipFile" class="form-label">ZIP File with Images & Masks</label>
                            <input class="form-control" type="file" id="zipFile" name="zipFile" accept=".zip" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="level" class="form-label">Training Level (1-5)</label>
                                    <select class="form-select" id="level" name="level">
                                        <option value="1">1 - Quick (2 epochs)</option>
                                        <option value="2">2 - Basic (5 epochs)</option>
                                        <option value="3" selected>3 - Standard (10 epochs)</option>
                                        <option value="4">4 - Extended (20 epochs)</option>
                                        <option value="5">5 - Thorough (30 epochs)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="image_size" class="form-label">Image Size</label>
                                    <select class="form-select" id="image_size" name="image_size">
                                        <option value="128">128 × 128</option>
                                        <option value="256" selected>256 × 256</option>
                                        <option value="384">384 × 384</option>
                                        <option value="512">512 × 512</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary" id="trainButton">
                                <i class="fas fa-cogs me-2"></i>Train Model
                            </button>
                        </div>
                    </form>

                    <div id="progressArea" class="mt-4 d-none">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                        </div>
                        <p class="text-center mt-2">Training in progress. This may take several minutes depending on your dataset size and selected training level.</p>
                    </div>

                    <div id="resultArea" class="mt-4 d-none">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Training Complete!</h5>
                            <p>Your segmentation model has been trained and is ready for download.</p>
                            <p>The download includes the model file, a README with usage instructions, and requirements.txt.</p>
                            <div class="d-grid mt-3">
                                <a id="downloadLink" href="#" class="btn btn-success">
                                    <i class="fas fa-download me-2"></i>Download Model
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="errorArea" class="mt-4 d-none">
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                            <p id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not services_status.semantic_segmentation_service %}
<div class="modal fade" id="serviceUnavailableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Service Unavailable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The semantic segmentation service is currently unavailable. Please try again later.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if not services_status.semantic_segmentation_service %}
        // Show modal if service is unavailable
        var serviceModal = new bootstrap.Modal(document.getElementById('serviceUnavailableModal'));
        serviceModal.show();
        {% endif %}

        const uploadForm = document.getElementById('uploadForm');
        const trainButton = document.getElementById('trainButton');
        const progressArea = document.getElementById('progressArea');
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const errorMessage = document.getElementById('errorMessage');
        const downloadLink = document.getElementById('downloadLink');

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show progress and hide other areas
            progressArea.classList.remove('d-none');
            resultArea.classList.add('d-none');
            errorArea.classList.add('d-none');
            
            // Disable the train button
            trainButton.disabled = true;
            
            const formData = new FormData(uploadForm);
            
            fetch('/api/train_segmentation', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                // Hide progress
                progressArea.classList.add('d-none');
                
                if (response.ok) {
                    // Get the blob data from the response
                    return response.blob().then(function(blob) {
                        // Create a download URL and link
                        const url = window.URL.createObjectURL(blob);
                        downloadLink.href = url;
                        downloadLink.download = 'segmentation_model.zip';
                        
                        // Show the result area
                        resultArea.classList.remove('d-none');
                        
                        // Trigger download automatically
                        downloadLink.click();
                    });
                } else {
                    // Handle error
                    return response.json().then(function(error) {
                        errorMessage.textContent = error.error || 'An unknown error occurred';
                        errorArea.classList.remove('d-none');
                    }).catch(function() {
                        errorMessage.textContent = `HTTP Error: ${response.status}`;
                        errorArea.classList.remove('d-none');
                    });
                }
            })
            .catch(function(err) {
                // Hide progress
                progressArea.classList.add('d-none');
                
                // Show error
                errorMessage.textContent = 'Network error: ' + err.message;
                errorArea.classList.remove('d-none');
            })
            .finally(function() {
                // Re-enable the train button
                trainButton.disabled = false;
            });
        });
    });
</script>
{% endblock %} 