{% extends "base.html" %}

{% block title %}Training Regression Models{% endblock %}

{% block head %}
{{ super() }}
<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        padding: 2rem 0;
    }
    
    .spinner {
        width: 100px;
        height: 100px;
        border: 10px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 10px solid #3498db;
        animation: spin 2s linear infinite;
        margin-bottom: 30px;
    }
    
    .progress-container {
        width: 80%;
        max-width: 500px;
        margin-top: 20px;
    }
    
    .status-message {
        margin-top: 20px;
        font-size: 18px;
        text-align: center;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .model-card {
        margin-bottom: 1rem;
        border-left: 4px solid #3498db;
    }
    
    .model-training {
        border-left-color: #f39c12;
    }
    
    .model-complete {
        border-left-color: #2ecc71;
    }
    
    .model-failed {
        border-left-color: #e74c3c;
    }
    
    .model-status-icon {
        margin-right: 0.5rem;
    }
    
    .stop-training-btn {
        margin-top: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card bg-dark border-secondary">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Training Regression Models</h3>
        </div>
        <div class="card-body">
            <div class="loading-container">
                <div class="spinner"></div>
                <h3 class="text-center">Our AI is building multiple regression models</h3>
                <div class="status-message" id="status-message">
                    <p>This process may take several minutes, depending on your dataset size and complexity.</p>
                    <p>We're analyzing your data and training multiple regression models to find the best one.</p>
                </div>
                
                <div class="model-status-container mt-4 w-100 px-4">
                    <h5 class="mb-3">Training Progress:</h5>
                    <div class="row" id="model-status-cards">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        Linear Regression
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        Lasso Regression
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        Ridge Regression
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        Random Forest Regression
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        K-Nearest Neighbors
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-dark model-card model-training">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="model-status-icon">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        XGBoost Regression
                                    </h6>
                                    <p class="card-text small">Training in progress...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress bg-dark">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                             style="width: 10%"></div>
                    </div>
                </div>
                
                <div class="stop-training-btn">
                    <form action="{{ url_for('stop_regression_training') }}" method="post">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-stop-circle mr-2"></i> Stop Training
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Redirect to results page once training is complete
    document.addEventListener('DOMContentLoaded', function() {
        const progressBar = document.getElementById('progress-bar');
        const statusMessage = document.getElementById('status-message');
        
        // Check the training status every few seconds
        function checkTrainingStatus() {
            fetch('/api/regression_training_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'complete') {
                        // Training completed successfully
                        updateModelStatusCards(data.model_statuses);
                        
                        statusMessage.innerHTML = '<p>Training complete! All models have been successfully trained.</p><p>Redirecting to results page...</p>';
                        progressBar.style.width = '100%';
                        progressBar.setAttribute('aria-valuenow', 100);
                        progressBar.classList.remove('progress-bar-animated');
                        
                        // Redirect to regression results page
                        setTimeout(() => {
                            window.location.href = "{{ url_for('regression_results') }}";
                        }, 1500);
                        
                        // Stop checking
                        clearInterval(statusCheckInterval);
                    }
                    else if (data.status === 'in_progress') {
                        // Update progress
                        let progress = data.progress || 10;
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);
                        
                        // Update model status cards if available
                        if (data.model_statuses) {
                            updateModelStatusCards(data.model_statuses);
                        }
                        
                        // Update status message if provided
                        if (data.message) {
                            statusMessage.innerHTML = '<p>' + data.message + '</p>';
                        }
                    }
                    else if (data.status === 'failed') {
                        // Training failed
                        statusMessage.innerHTML = '<p class="text-danger">Training failed: ' + data.message + '</p>';
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-danger');
                        
                        // Update model status cards
                        if (data.model_statuses) {
                            updateModelStatusCards(data.model_statuses);
                        }
                        
                        // Stop checking
                        clearInterval(statusCheckInterval);
                    }
                })
                .catch(error => {
                    console.error('Error checking training status:', error);
                    // Continue checking - could be temporary network issue
                });
        }
        
        // Function to update the model status cards
        function updateModelStatusCards(modelStatuses) {
            const modelCards = document.getElementById('model-status-cards');
            if (!modelCards || !modelStatuses) return;
            
            // Clear existing cards
            modelCards.innerHTML = '';
            
            // Add updated cards
            for (const [modelName, status] of Object.entries(modelStatuses)) {
                let statusClass = 'model-training';
                let statusIcon = '<i class="fas fa-spinner fa-spin"></i>';
                let statusText = 'Training in progress...';
                
                if (status === 'complete') {
                    statusClass = 'model-complete';
                    statusIcon = '<i class="fas fa-check-circle"></i>';
                    statusText = 'Training complete';
                } else if (status === 'failed') {
                    statusClass = 'model-failed';
                    statusIcon = '<i class="fas fa-times-circle"></i>';
                    statusText = 'Training failed';
                } else if (status === 'waiting') {
                    statusIcon = '<i class="fas fa-clock"></i>';
                    statusText = 'Waiting to start...';
                }
                
                const cardHtml = `
                    <div class="col-md-6 mb-3">
                        <div class="card bg-dark model-card ${statusClass}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <span class="model-status-icon">
                                        ${statusIcon}
                                    </span>
                                    ${modelName}
                                </h6>
                                <p class="card-text small">${statusText}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                modelCards.innerHTML += cardHtml;
            }
        }
        
        // Start checking status
        checkTrainingStatus(); // Check immediately
        const statusCheckInterval = setInterval(checkTrainingStatus, 3000); // Then every 3 seconds
    });
</script>
{% endblock %} 