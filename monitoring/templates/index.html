<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepMed Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.6.0/dist/chart.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: none;
        }
        .card-header {
            border-radius: 8px 8px 0 0;
            font-weight: 600;
        }
        .service-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .service-card:hover {
            transform: translateY(-3px);
        }
        .service-up {
            border-left: 5px solid #28a745;
        }
        .service-down {
            border-left: 5px solid #dc3545;
        }
        .service-unknown {
            border-left: 5px solid #ffc107;
        }
        .dashboard-title {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .status-badge {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        .service-details {
            font-size: 14px;
            color: #6c757d;
        }
        .category-header {
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .test-form {
            background-color: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
        }
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center dashboard-title">
            <h1>DeepMed Monitoring Dashboard</h1>
            <div>
                <button class="btn btn-primary" id="refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Services</h5>
                        <h2 id="total-services">Loading...</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Healthy Services</h5>
                        <h2 id="healthy-services">Loading...</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Unhealthy Services</h5>
                        <h2 id="unhealthy-services">Loading...</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Unknown Status</h5>
                        <h2 id="unknown-services">Loading...</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- Services Status Cards -->
                {% for category, category_services in services.items() %}
                <div class="category-section mb-4">
                    <h3 class="category-header">{{ category }}</h3>
                    <div class="row">
                        {% for service_name, service_info in category_services.items() %}
                        <div class="col-md-6 mb-3">
                            <div class="card service-card {% if service_info.status == 'up' %}service-up{% elif service_info.status == 'down' %}service-down{% else %}service-unknown{% endif %}" 
                                 data-service="{{ service_name }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="card-title mb-0">{{ service_name }}</h5>
                                        {% if service_info.status == 'up' %}
                                        <span class="status-badge bg-success">Up</span>
                                        {% elif service_info.status == 'down' %}
                                        <span class="status-badge bg-danger">Down</span>
                                        {% else %}
                                        <span class="status-badge bg-warning">Unknown</span>
                                        {% endif %}
                                    </div>
                                    <p class="service-details">{{ service_info.description }}</p>
                                    <div class="d-flex justify-content-between">
                                        <small>{{ service_info.url }}</small>
                                        <small>Last check: {{ service_info.last_check if service_info.last_check else "Never" }}</small>
                                    </div>
                                    {% if service_info.response_time %}
                                    <div class="text-end">
                                        <small>Response time: {{ service_info.response_time }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <!-- Service Detail Modal -->
                <div class="modal fade" id="serviceDetailModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="serviceDetailTitle">Service Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="chart-container mb-4">
                                    <div id="response-time-chart"></div>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">Service Information</div>
                                    <div class="card-body">
                                        <table class="table table-striped">
                                            <tbody id="service-info-table">
                                                <!-- Service info will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-success text-white">Test Endpoint</div>
                                    <div class="card-body">
                                        <form id="test-endpoint-form" class="test-form">
                                            <div class="mb-3">
                                                <label for="endpoint-input" class="form-label">Endpoint Path</label>
                                                <input type="text" class="form-control" id="endpoint-input" value="/health">
                                            </div>
                                            <div class="mb-3">
                                                <label for="method-select" class="form-label">HTTP Method</label>
                                                <select class="form-select" id="method-select">
                                                    <option value="GET">GET</option>
                                                    <option value="POST">POST</option>
                                                </select>
                                            </div>
                                            <div class="mb-3" id="payload-container" style="display: none;">
                                                <label for="payload-input" class="form-label">JSON Payload</label>
                                                <textarea class="form-control" id="payload-input" rows="4"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Test Endpoint</button>
                                        </form>
                                        <div class="mt-3" id="endpoint-result" style="display: none;">
                                            <div class="card">
                                                <div class="card-header">Response</div>
                                                <div class="card-body">
                                                    <pre id="endpoint-result-content" class="bg-light p-3 rounded"></pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Test Runner Panel -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Test Runner</h5>
                    </div>
                    <div class="card-body">
                        <form id="test-runner-form">
                            <div class="mb-3">
                                <label for="test-file-input" class="form-label">Test File Path</label>
                                <input type="text" class="form-control" id="test-file-input" placeholder="../tests/test_example.py">
                            </div>
                            <button type="submit" class="btn btn-info text-white">Run Test</button>
                        </form>
                        <div class="mt-3" id="test-results" style="display: none;">
                            <div class="card">
                                <div class="card-header" id="test-result-header">Test Results</div>
                                <div class="card-body" id="test-result-content">
                                    <!-- Test results will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Status Chart -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">System Health Overview</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="status-chart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Prometheus Metrics Link -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Monitoring Tools</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/api/metrics" target="_blank" class="btn btn-outline-dark">View Prometheus Metrics</a>
                            <a href="http://localhost:9090" target="_blank" class="btn btn-outline-primary">Open Prometheus Dashboard</a>
                            <a href="http://localhost:3000" target="_blank" class="btn btn-outline-success">Open Grafana Dashboard</a>
                            <button class="btn btn-outline-secondary" id="export-status-btn">Export Status Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container for notifications -->
    <div id="toast-container"></div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize variables and DOM elements
        const serviceCards = document.querySelectorAll('.service-card');
        const refreshBtn = document.getElementById('refresh-btn');
        const testRunnerForm = document.getElementById('test-runner-form');
        const testEndpointForm = document.getElementById('test-endpoint-form');
        const methodSelect = document.getElementById('method-select');
        const payloadContainer = document.getElementById('payload-container');
        const exportStatusBtn = document.getElementById('export-status-btn');
        
        // Bootstrap modal instance
        let serviceModal;
        
        // Initialize charts and counters
        let statusChart;
        let currentServiceName;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the modal
            serviceModal = new bootstrap.Modal(document.getElementById('serviceDetailModal'));
            
            // Initialize the status chart
            const ctx = document.getElementById('status-chart').getContext('2d');
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Up', 'Down', 'Unknown'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Update dashboard with initial data
            updateDashboard();
            
            // Set up event handlers
            setupEventHandlers();
        });
        
        function setupEventHandlers() {
            // Service card click handler
            serviceCards.forEach(card => {
                card.addEventListener('click', function() {
                    const serviceName = this.getAttribute('data-service');
                    openServiceDetails(serviceName);
                });
            });
            
            // Refresh button click handler
            refreshBtn.addEventListener('click', function() {
                refreshServices();
            });
            
            // Method select change handler
            methodSelect.addEventListener('change', function() {
                payloadContainer.style.display = this.value === 'POST' ? 'block' : 'none';
            });
            
            // Test endpoint form submit handler
            testEndpointForm.addEventListener('submit', function(e) {
                e.preventDefault();
                testEndpoint();
            });
            
            // Test runner form submit handler
            testRunnerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                runTest();
            });
            
            // Export status button click handler
            exportStatusBtn.addEventListener('click', function() {
                exportStatusReport();
            });
        }
        
        function updateDashboard() {
            fetch('/api/services')
                .then(response => response.json())
                .then(services => {
                    // Count services by status
                    let totalCount = 0;
                    let upCount = 0;
                    let downCount = 0;
                    let unknownCount = 0;
                    
                    // Process all services
                    for (const category in services) {
                        for (const serviceName in services[category]) {
                            totalCount++;
                            const status = services[category][serviceName].status;
                            
                            if (status === 'up') upCount++;
                            else if (status === 'down') downCount++;
                            else unknownCount++;
                            
                            // Update service card status
                            const card = document.querySelector(`.service-card[data-service="${serviceName}"]`);
                            if (card) {
                                // Remove existing status classes
                                card.classList.remove('service-up', 'service-down', 'service-unknown');
                                
                                // Add appropriate status class
                                if (status === 'up') card.classList.add('service-up');
                                else if (status === 'down') card.classList.add('service-down');
                                else card.classList.add('service-unknown');
                                
                                // Update status badge
                                const badge = card.querySelector('.status-badge');
                                if (badge) {
                                    badge.className = 'status-badge';
                                    if (status === 'up') badge.classList.add('bg-success');
                                    else if (status === 'down') badge.classList.add('bg-danger');
                                    else badge.classList.add('bg-warning');
                                    
                                    badge.textContent = status === 'up' ? 'Up' : status === 'down' ? 'Down' : 'Unknown';
                                }
                                
                                // Update last check and response time
                                const lastCheck = card.querySelector('small:nth-of-type(2)');
                                if (lastCheck) {
                                    lastCheck.textContent = `Last check: ${services[category][serviceName].last_check || 'Never'}`;
                                }
                                
                                const responseTime = card.querySelectorAll('small')[2];
                                if (responseTime) {
                                    responseTime.textContent = `Response time: ${services[category][serviceName].response_time || 'N/A'}`;
                                }
                            }
                        }
                    }
                    
                    // Update counter cards
                    document.getElementById('total-services').textContent = totalCount;
                    document.getElementById('healthy-services').textContent = upCount;
                    document.getElementById('unhealthy-services').textContent = downCount;
                    document.getElementById('unknown-services').textContent = unknownCount;
                    
                    // Update status chart
                    statusChart.data.datasets[0].data = [upCount, downCount, unknownCount];
                    statusChart.update();
                })
                .catch(error => {
                    console.error('Error updating dashboard:', error);
                    showToast('Error updating dashboard. See console for details.', 'danger');
                });
        }
        
        function refreshServices() {
            showToast('Refreshing services...', 'info');
            
            fetch('/api/refresh')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'refreshed') {
                        updateDashboard();
                        showToast('Services refreshed successfully!', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing services:', error);
                    showToast('Error refreshing services', 'danger');
                });
        }
        
        function openServiceDetails(serviceName) {
            currentServiceName = serviceName;
            
            // Set modal title
            document.getElementById('serviceDetailTitle').textContent = `Service: ${serviceName}`;
            
            // Clear previous content
            document.getElementById('service-info-table').innerHTML = '';
            document.getElementById('endpoint-result').style.display = 'none';
            
            // Find service info
            let serviceInfo = null;
            let category = null;
            
            fetch('/api/services')
                .then(response => response.json())
                .then(services => {
                    // Find the service in the categories
                    for (const cat in services) {
                        if (services[cat][serviceName]) {
                            serviceInfo = services[cat][serviceName];
                            category = cat;
                            break;
                        }
                    }
                    
                    if (!serviceInfo) {
                        showToast(`Service ${serviceName} not found`, 'danger');
                        return;
                    }
                    
                    // Build service info table
                    const infoTable = document.getElementById('service-info-table');
                    
                    // Add basic info
                    const rows = [
                        { name: 'Name', value: serviceName },
                        { name: 'Category', value: category },
                        { name: 'URL', value: serviceInfo.url },
                        { name: 'Status', value: serviceInfo.status },
                        { name: 'Last Check', value: serviceInfo.last_check || 'Never' },
                        { name: 'Response Time', value: serviceInfo.response_time || 'N/A' },
                        { name: 'Description', value: serviceInfo.description || 'No description' }
                    ];
                    
                    // Add rows to table
                    rows.forEach(row => {
                        const tr = document.createElement('tr');
                        
                        const th = document.createElement('th');
                        th.textContent = row.name;
                        
                        const td = document.createElement('td');
                        
                        // Format status with color
                        if (row.name === 'Status') {
                            const badge = document.createElement('span');
                            badge.classList.add('badge', 'rounded-pill');
                            
                            if (row.value === 'up') {
                                badge.classList.add('bg-success');
                                badge.textContent = 'Up';
                            } else if (row.value === 'down') {
                                badge.classList.add('bg-danger');
                                badge.textContent = 'Down';
                            } else {
                                badge.classList.add('bg-warning');
                                badge.textContent = 'Unknown';
                            }
                            
                            td.appendChild(badge);
                        } else {
                            td.textContent = row.value;
                        }
                        
                        tr.appendChild(th);
                        tr.appendChild(td);
                        infoTable.appendChild(tr);
                    });
                    
                    // Add details if available
                    if (serviceInfo.details) {
                        const tr = document.createElement('tr');
                        
                        const th = document.createElement('th');
                        th.textContent = 'Details';
                        
                        const td = document.createElement('td');
                        const pre = document.createElement('pre');
                        pre.classList.add('mb-0', 'bg-light', 'p-2', 'rounded');
                        pre.textContent = JSON.stringify(serviceInfo.details, null, 2);
                        
                        td.appendChild(pre);
                        tr.appendChild(th);
                        tr.appendChild(td);
                        infoTable.appendChild(tr);
                    }
                    
                    // Fetch and display service history chart
                    fetch(`/api/service_history/${serviceName}`)
                        .then(response => response.json())
                        .then(historyData => {
                            if (historyData.chart) {
                                const chartDiv = document.getElementById('response-time-chart');
                                Plotly.newPlot(chartDiv, JSON.parse(historyData.chart));
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching service history:', error);
                        });
                    
                    // Show the modal
                    serviceModal.show();
                })
                .catch(error => {
                    console.error('Error fetching service details:', error);
                    showToast('Error fetching service details', 'danger');
                });
        }
        
        function testEndpoint() {
            const endpoint = document.getElementById('endpoint-input').value;
            const method = document.getElementById('method-select').value;
            let payload = null;
            
            if (method === 'POST') {
                try {
                    payload = JSON.parse(document.getElementById('payload-input').value);
                } catch (e) {
                    showToast('Invalid JSON payload', 'danger');
                    return;
                }
            }
            
            fetch(`/api/test_endpoint/${currentServiceName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    endpoint: endpoint,
                    method: method,
                    payload: payload
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('endpoint-result');
                const resultContent = document.getElementById('endpoint-result-content');
                
                if (data.error) {
                    resultContent.textContent = `Error: ${data.error}`;
                } else {
                    resultContent.textContent = JSON.stringify(data, null, 2);
                }
                
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error testing endpoint:', error);
                showToast('Error testing endpoint', 'danger');
            });
        }
        
        function runTest() {
            const testFile = document.getElementById('test-file-input').value;
            
            if (!testFile) {
                showToast('Please enter a test file path', 'warning');
                return;
            }
            
            fetch('/api/run_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_file: testFile
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('test-results');
                const header = document.getElementById('test-result-header');
                const content = document.getElementById('test-result-content');
                
                resultDiv.style.display = 'block';
                
                if (data.status === 'pass') {
                    header.className = 'card-header bg-success text-white';
                    header.textContent = 'Test Passed';
                    content.innerHTML = `<div class="alert alert-success mb-0">Test "${data.test}" passed successfully!</div>`;
                } else if (data.status === 'fail') {
                    header.className = 'card-header bg-danger text-white';
                    header.textContent = 'Test Failed';
                    content.innerHTML = `<div class="alert alert-danger mb-0">Test "${data.test}" failed.</div>`;
                } else {
                    header.className = 'card-header bg-warning text-white';
                    header.textContent = 'Test Error';
                    content.innerHTML = `<div class="alert alert-warning mb-0">Error running test "${data.test}": ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error running test:', error);
                showToast('Error running test', 'danger');
            });
        }
        
        function exportStatusReport() {
            fetch('/api/services')
                .then(response => response.json())
                .then(services => {
                    // Create a report object
                    const report = {
                        timestamp: new Date().toISOString(),
                        services: services,
                        summary: {
                            total: 0,
                            up: 0,
                            down: 0,
                            unknown: 0
                        }
                    };
                    
                    // Calculate summary
                    for (const category in services) {
                        for (const serviceName in services[category]) {
                            report.summary.total++;
                            const status = services[category][serviceName].status;
                            
                            if (status === 'up') report.summary.up++;
                            else if (status === 'down') report.summary.down++;
                            else report.summary.unknown++;
                        }
                    }
                    
                    // Convert to JSON and create download link
                    const jsonData = JSON.stringify(report, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `deepmed-status-report-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 0);
                    
                    showToast('Status report exported successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error exporting status report:', error);
                    showToast('Error exporting status report', 'danger');
                });
        }
        
        function showToast(message, type) {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast show bg-${type} text-white`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 5000);
        }
        
        // Auto-refresh every 60 seconds
        setInterval(updateDashboard, 60000);
    </script>
</body>
</html> 